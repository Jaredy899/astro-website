---
import { getCollection } from 'astro:content';
import { cleanSlug } from '../../utils/slug';
import Layout from '../../layouts/Layout.astro';
import JCLogo from '../../components/JCLogo.astro';

export async function getStaticPaths() {
	const posts = await getCollection('blog');
	return posts
		.filter(post => !post.data.draft)
		.flatMap((post) => {
			const cleaned = cleanSlug(post.slug);
			const base = [{ params: { slug: cleaned }, props: post }];
			if (cleaned !== post.slug) {
				base.push({ params: { slug: post.slug }, props: post });
			}
			return base;
		});
}

const post = Astro.props;
const { title, pubDate, description } = post.data;
const { Content } = await post.render();

// Format date to be more readable
const formatDate = (date: Date) => {
	// Ensure we're working with UTC dates
	const utcDate = new Date(Date.UTC(
		date.getUTCFullYear(),
		date.getUTCMonth(),
		date.getUTCDate()
	));
	return utcDate.toLocaleDateString('en-US', {
		year: 'numeric',
		month: 'long',
		day: 'numeric',
		timeZone: 'UTC'
	});
};

---

<Layout title={title} description={description}>
	<header class="page-header" id="page-header">
		<button id="header-sidebar-toggle" aria-label="Toggle sidebar">
			<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
				<rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
				<line x1="8" y1="6" x2="8" y2="18"></line>
			</svg>
		</button>
		<div class="logo-container" transition:name="jc-logo">
			<a href="/" class="logo-link" aria-label="Return to home page">
				<JCLogo />
			</a>
		</div>
		<button id="header-theme-toggle" aria-label="Toggle dark mode">
			<svg id="header-sun-icon" class="hidden" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
				<circle cx="12" cy="12" r="5"></circle>
				<line x1="12" y1="1" x2="12" y2="3"></line>
				<line x1="12" y1="21" x2="12" y2="23"></line>
				<line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
				<line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
				<line x1="1" y1="12" x2="3" y2="12"></line>
				<line x1="21" y1="12" x2="23" y2="12"></line>
				<line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
				<line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
			</svg>
			<svg id="header-moon-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
				<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
			</svg>
		</button>
	</header>
	<main class="container mx-auto px-4 py-8 blog-main">
		<article class="prose dark:prose-invert mx-auto fade-in blog-post">
			<time class="text-sm text-gray-500 dark:text-gray-400 blog-date">
				{formatDate(new Date(pubDate))}
			</time>
			<div class="mt-8 blog-content">
				<Content />
			</div>
		</article>
	</main>
</Layout>

<script>
	// Blog header scroll behavior and controls
	const setupBlogHeader = () => {
		let lastScrollY = 0;
		const header = document.getElementById('page-header');
		const headerSidebarToggle = document.getElementById('header-sidebar-toggle');
		const headerThemeToggle = document.getElementById('header-theme-toggle');
		const headerSunIcon = document.getElementById('header-sun-icon');
		const headerMoonIcon = document.getElementById('header-moon-icon');
		
		if (!header) return;
		
		const handleScroll = () => {
			const currentScrollY = window.scrollY;
			
			if (currentScrollY < 100) {
				header.classList.remove('header-hidden');
			} else if (currentScrollY > lastScrollY) {
				header.classList.add('header-hidden');
			} else {
				header.classList.remove('header-hidden');
			}
			
			lastScrollY = currentScrollY;
		};
		
		window.addEventListener('scroll', handleScroll, { passive: true });
		
		// Setup header sidebar toggle
		if (headerSidebarToggle && !headerSidebarToggle.hasAttribute('data-header-handler')) {
			headerSidebarToggle.setAttribute('data-header-handler', 'true');
			headerSidebarToggle.addEventListener('click', () => {
				if (typeof (window as any).toggleSidebar === 'function') {
					(window as any).toggleSidebar();
				}
			});
		}
		
		// Sync header theme icons with current theme
		const syncHeaderThemeIcons = () => {
			const isDark = document.documentElement.classList.contains('dark');
			if (isDark) {
				headerSunIcon?.classList.remove('hidden');
				headerMoonIcon?.classList.add('hidden');
			} else {
				headerSunIcon?.classList.add('hidden');
				headerMoonIcon?.classList.remove('hidden');
			}
		};
		
		// Initial sync
		syncHeaderThemeIcons();
		
		// Setup header theme toggle
		if (headerThemeToggle && !headerThemeToggle.hasAttribute('data-header-theme-handler')) {
			headerThemeToggle.setAttribute('data-header-theme-handler', 'true');
			headerThemeToggle.addEventListener('click', () => {
				const element = document.documentElement;
				const isDark = element.classList.toggle('dark');
				const theme = isDark ? 'dark' : 'light';
				
				if (typeof localStorage !== 'undefined') {
					localStorage.setItem('theme', theme);
				}
				
				// Sync header icons
				syncHeaderThemeIcons();
				
				// Also sync main theme toggle icons
				const sunIcon = document.getElementById('sun-icon');
				const moonIcon = document.getElementById('moon-icon');
				if (isDark) {
					sunIcon?.classList.remove('hidden');
					moonIcon?.classList.add('hidden');
				} else {
					sunIcon?.classList.add('hidden');
					moonIcon?.classList.remove('hidden');
				}
			});
		}
	};
	
	// Run on initial load and after view transitions
	if (typeof document !== 'undefined') {
		if (document.readyState === 'loading') {
			document.addEventListener('DOMContentLoaded', setupBlogHeader);
		} else {
			setupBlogHeader();
		}
		document.addEventListener('astro:page-load', setupBlogHeader);
	}
</script>



<style>
	.container {
		max-width: 800px;
	}

/* Add specific tablet and desktop adjustments */
@media screen and (min-width: 768px) and (max-width: 1280px) {
  .container {
    padding-left: 5rem !important; /* Add more padding on the left to account for sidebar */
    padding-right: 2rem !important;
  }

  .blog-date {
    margin-left: 0.5rem; /* Add some margin to the date */
  }
}

	/* Blog Page Header */
	.page-header {
		position: fixed;
		top: 1rem;
		left: 1rem;
		right: 1rem;
		z-index: 10;
		display: flex;
		justify-content: space-between;
		align-items: center;
		transition: transform 0.3s ease;
	}

	.page-header.header-hidden {
		transform: translateY(-100%);
	}

	.page-header .logo-container {
		position: absolute;
		left: 50%;
		transform: translateX(-50%);
		width: 60px;
		height: 60px;
		color: var(--text);
		margin: 0;
		top: auto;
	}

	.page-header .logo-link {
		display: block;
		width: 100%;
		height: 100%;
		color: inherit;
		text-decoration: none;
		transition: opacity 0.2s ease, transform 0.2s ease;
	}

	.page-header .logo-link:hover {
		opacity: 0.8;
		transform: scale(1.05);
	}

	#header-sidebar-toggle,
	#header-theme-toggle {
		padding: 0.25rem;
		border-radius: 50%;
		border: none;
		background: transparent;
		color: var(--text);
		cursor: pointer;
		transition: transform 0.3s ease;
	}

	#header-sidebar-toggle:hover,
	#header-theme-toggle:hover {
		transform: scale(1.1);
	}

	.hidden {
		display: none;
	}

	.blog-main {
		padding-top: 6rem;
	}

	/* Hide global controls on blog pages when page-header is present */
	:global(body:has(.page-header) > #sidebar-toggle),
	:global(body:has(.page-header) > #theme-toggle) {
		display: none !important;
	}

	.logo-container {
		width: 40px;
		height: 40px;
		margin: 1rem auto;
		transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
		position: absolute;
		top: 0;
		left: 50%;
		transform: translateX(-50%);
		color: var(--text) !important;
	}

	.logo-container :global(svg) {
		color: var(--text) !important;
	}

	.logo-link {
		display: block;
		text-decoration: none;
		transition: transform 0.3s ease;
	}

	.logo-link:hover {
		transform: scale(1.1);
	}

	.fade-in {
		animation: fadeIn 0.5s ease-in;
	}

	@keyframes fadeIn {
		from {
			opacity: 0;
			transform: translateY(10px);
		}
		to {
			opacity: 1;
			transform: translateY(0);
		}
	}

	.blog-post {
		font-family: 'Inter', system-ui, -apple-system, sans-serif;
		line-height: 1.8;
	}

	.blog-title {
		font-family: 'Inter', system-ui, -apple-system, sans-serif;
		font-size: 2.5rem;
		font-weight: 700;
		line-height: 1.2;
		margin-bottom: 1rem;
		color: var(--text);
	}

	.blog-date {
		font-family: 'Inter', sans-serif;
		font-size: 0.9rem;
		letter-spacing: 0.05em;
		text-transform: uppercase;
	}

	.blog-content {
		font-size: 1.1rem;
	}

	/* More assertive CSS for images within blog-content */
	.blog-content :global(img) {
		max-width: 100% !important; /* Use !important to potentially override other styles */
		height: auto !important; /* Use !important */
		display: block !important; /* Use !important */
		margin: 1.5rem auto !important; /* Use !important */
		box-sizing: border-box !important; /* Ensure padding/border calculations are standard */
		object-fit: contain; /* Ensure the entire image is visible without stretching */
		border-radius: 8px; /* Optional: Add rounded corners to the image */
		box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* Optional: Add a subtle shadow */
	}

	/* Optional: Specific styling for images in dark mode if needed */
	:global(.dark) .blog-content :global(img) {
		box-shadow: 0 4px 8px rgba(255, 255, 255, 0.05);
	}


	.blog-content :global(h1) {
		font-family: 'Inter', sans-serif;
		font-size: 2rem;
		font-weight: 600;
		letter-spacing: -0.02em;
		margin-top: 2rem;
		margin-bottom: 1rem;
		color: var(--text);
	}

	.blog-content h2 {
		font-family: 'Playfair Display', serif;
		font-size: 1.8rem;
		margin-top: 2rem;
		margin-bottom: 1rem;
		color: var(--text);
	}

	.blog-content p {
		margin-bottom: 1.5rem;
	}

	.blog-content ul, .blog-content ol {
		margin-bottom: 1.5rem;
		padding-left: 1.5rem;
	}

	.blog-content li {
		margin-bottom: 0.5rem;
	}

	.blog-content code {
		font-family: 'Fira Code', monospace;
		background: rgba(0, 0, 0, 0.05);
		padding: 0.2em 0.4em;
		border-radius: 3px;
		font-size: 0.9em;
	}

	.blog-content pre {
		background: #1a1a1a;
		padding: 1rem;
		border-radius: 8px;
		overflow-x: auto;
		margin: 1.5rem 0;
		position: relative;
	}

	.blog-content pre code {
		background: none;
		padding: 0;
		color: #fff;
		display: block;
	}

	:global(.dark) .blog-content code {
		background: rgba(255, 255, 255, 0.1);
	}

	:global(.dark) .blog-content pre {
		background: #2a2a2a;
	}

	:global(.dark) .blog-title {
		color: var(--text);
	}

	:global(.dark) .blog-content :global(h1) {
		color: var(--text);
	}

	/* Override prose styles for pre elements */
	:global(.prose) pre {
		tabindex: unset !important;
	}



	.blog-content :global(a) {
		color: var(--link-color);
		text-decoration: none;
		transition: opacity 0.2s ease;
	}

	.blog-content :global(a:hover) {
		opacity: 0.8;
	}
</style>